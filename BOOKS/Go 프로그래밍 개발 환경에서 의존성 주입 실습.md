# Go 프로그래밍 개발 환경에서 의존성 주입 실습
 코리 스캇 지음. 이준 옮김.
 
## go-tools
* 목커리, SQLMOCK: 목킹 라이브러리
* godepgraph : 의존성 그래프 그리는 도구
* package-coverage : 패키지 단위 커버리지 측정 도구(세부 디렉터리 기준으로 가능)

## 의존성 주입 방법

1. 몽키 패치
2. 생성자 의존성 주입
3. 메서드 의존성 주입
4. 컨피그에 의한 의존성 주입
5. JIT 의존성 주입
6. 구글 와이어 프레임워크를 이용한 의존성 주입 (프레임워크 사용)

### 몽키 패치
 런타임 시 한 변수를 다른 변수로 변환하는 방법이다.
 
* 가장 이상적인 사용 사례는?
  * 싱글톤에 의존하는 코드가 있는 경우
  * 최소한의 변경으로 테스트 코드를 추가하려는 경우
  * 의존하고 있는 패키지를 변경하지 않고, 두 패키지를 분리하려는 경우
  
```go
var writeLog = func(string) error

func foo() {
    ..
    err := writeLog("hello world..")
    ..
}

func TestFoo(t *testing.T) {
  // 원상 복구한다.
  defer func(origin func(string)error) {
  	writeLog = origin
  }(writeLog)

  // 몽키패치
  writeLog = ...
}
```

### 생성자 주입
 전통적인 DI 기법으로 의존성을 생성자 인자로 전달한다.
 
* 의존성이 nil인 경우에 대한 방어 로직이 필요하다.
  * 상황에 따라 noop 기법을 사용해도 된다.
* 생성자에서 유효성 검사를 하고 메서드에선 유효성 검사를 할 필요가 없다.  
* 가장 이상적인 사용 사례는?
  * 의존성이 필요한 경우
  * 객체의 대부분 또는 모든 메서드에 의해 의존성이 사용되는 경우
  * 의존성에 대해 여러 구현체가 있는 경우
  * 요청 간에 의존성이 변경되지 않는 경우
  
### 메서드 주입
 전통적인 DI 기법으로 의존성을 메서드 인자로 전달한다.

* 가장 이상적인 사용 사례는?
  * 함수, 프레임워크, 고융 라이브러리
  * 컨테스트 또는 사용자 자격 증명과 같은 범위가 제한된 의존성을 요청하는 경우
  * 무상태 객체
  * 요청 과정에서 컨텍스트 또는 데이터를 제공하는 의존성 및 호출마다 예상되는 의존성이 달라지는 경우
  
### 컨피그에 의한 의존성 주입
 config 패키지와 전역변수 하나 만들고 각 패키지 마다 Config interface를 생성해서 주입한다.
 
* 많은 의존성을 줄 일 수 있지만, 가독성은 떨어질 수 있다.
* 경계 테스트를 유용하게 할 수 있다.
```go
server := httptest.NewServer(..)
cfg := &Config{
  url: server.URL,
}

result := DoIt(cfg)
..
```

* 가장 이상적인 사용 사례는?
  * 생성자 주입, 메서드 주입과 동일한 상황에 사용될 수 있다.
  * 가독성에 대한 충분한 고민을 한 후 적용 여부를 결정해야한다.
  
### JIT 의존성 주입 (just-in-time)
 JIT 주입은 생성자로 Getter 함수를 받아서 사용할때 Get()해서 의존성을 주입하여 사용한다.
 
* 몽키패치를 대체할 수 있다.
* JIT 주입이 아닐 경우, 생성자에 주입되고 하나의 프로덕션 구현만 있어 의존성을 대체하는 경우
* 객체와 전역 싱글톤 사이에 간접 계층이나 추상화 계층을 제공하는 경우, 특히 테스트 중에 전역 싱글톤을 교체하는 경우에는 더욱 그렇다.
* 의존성을 사용자가 선택적으로 제공하도록 허용하는 경우

```go
type FooObject struct {
  model Model
}

func (f FooObject)foo() {
    return f.Getter().Do()	
}

func (f FooObject)Getter() model {
  if f.model == nil {
    return TestModel{}
  }
  return f.model
}
```

### 구글 와이어 프레임워크를 이용한 의존성 주입 (프레임워크 사용)
 프레임워크를 이용한 의존성 주입

* Go 철학에 맞는가? ... 아닌거 같은데
* 프레임워크에 의존할 떄 문제점을 고스란히 얻는다. (반대도 마찬가지)


## 결론
* 기본적인 SOLID 원칙과 DI에 대한 기본 개념을 설명했지만, 대부분 알고 있어 따로 정리하진 않았다.
* 상황에 맞게 적절한 DI 기법을 생각하자
  * 이미 알고 있는 방식들이었지만, 정리를 통해 카테고리화하고 상황에 따라 적용한다.
  * 특히, Go에서 적용하기 쉬운 몽키패치 방식과 Config에 의한 의존성 주입 방식이 흥미로웠다.
* 의존성 시각화 도구를 이용하여 의존성을 관리하자